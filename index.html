<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上 7z 解壓縮工具 - 安全、快速、免上傳</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .drop-zone {
            transition: all 0.3s ease;
            border: 2px dashed #cbd5e1;
        }
        .drop-zone.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: scale(1.01);
        }
        .file-card {
            transition: transform 0.2s ease;
        }
        .file-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="min-h-screen py-12 px-4">

    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-slate-800 mb-4 flex items-center justify-center gap-3">
                <i data-lucide="archive" class="w-10 h-10 text-blue-600"></i>
                線上 7z 解壓縮工具
            </h1>
            <div id="engineStatusWrapper" class="flex flex-col items-center gap-2">
                <p class="text-slate-600 max-w-lg mx-auto">
                    無需安裝軟體，直接在瀏覽器中解壓 7z 檔案。
                </p>
                <div class="flex items-center gap-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" id="libStatusBadge">
                        <span id="libStatusText">正在檢查核心元件...</span>
                    </span>
                    <button id="retryLibBtn" class="hidden text-xs text-blue-600 hover:underline flex items-center gap-1">
                        <i data-lucide="rotate-cw" class="w-3 h-3"></i> 點此重試載入
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 border border-slate-100">
            
            <div id="dropZone" class="drop-zone rounded-xl p-10 text-center cursor-pointer mb-8 group">
                <input type="file" id="fileInput" class="hidden" accept=".7z">
                <div id="uploadContent">
                    <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-1">點擊或拖放 7z 檔案至此</h3>
                    <p class="text-sm text-slate-500">支援 .7z 格式</p>
                </div>
                
                <div id="loadingStatus" class="hidden">
                    <div class="flex flex-col items-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                        <p class="text-slate-700 font-medium">正在處理壓縮檔...</p>
                        <p class="text-xs text-slate-400 mt-2">大型檔案或解密可能需要較長時間</p>
                    </div>
                </div>
            </div>

            <div id="resultSection" class="hidden">
                <div class="flex items-center justify-between mb-4 border-b pb-4">
                    <div class="flex items-center gap-2 text-slate-800 font-semibold">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                        檔案清單 (<span id="fileCount">0</span>)
                    </div>
                    <button id="resetBtn" class="text-sm text-slate-500 hover:text-red-500 flex items-center gap-1 transition-colors">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> 清除重新開始
                    </button>
                </div>
                
                <div id="fileList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2"></div>
            </div>

            <div id="messageBox" class="hidden mt-4 p-4 rounded-lg text-sm whitespace-pre-line"></div>
        </div>
    </div>

    <!-- 核心腳本載入 -->
    <script id="archiveScript" src="https://cdn.jsdelivr.net/npm/libarchive.js@1.3.0/dist/libarchive.js"></script>

    <script>
        // 安全初始化 Lucide 的函數
        function initIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                console.warn('Lucide library not yet loaded.');
            }
        }

        // 頁面初次載入嘗試初始化
        window.addEventListener('load', initIcons);

        const libStatusBadge = document.getElementById('libStatusBadge');
        const libStatusText = document.getElementById('libStatusText');
        const retryLibBtn = document.getElementById('retryLibBtn');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const uploadContent = document.getElementById('uploadContent');
        const loadingStatus = document.getElementById('loadingStatus');
        const resultSection = document.getElementById('resultSection');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');
        const resetBtn = document.getElementById('resetBtn');
        const messageBox = document.getElementById('messageBox');

        let isInitialized = false;

        function updateStatus(status) {
            libStatusBadge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ";
            if (status === 'ready') {
                libStatusBadge.classList.add("bg-green-100", "text-green-800");
                libStatusText.textContent = "解壓引擎：就緒";
                retryLibBtn.classList.add('hidden');
            } else if (status === 'loading') {
                libStatusBadge.classList.add("bg-blue-100", "text-blue-800");
                libStatusText.textContent = "解壓引擎：正在載入...";
                retryLibBtn.classList.add('hidden');
            } else {
                libStatusBadge.classList.add("bg-red-100", "text-red-800");
                libStatusText.textContent = "解壓引擎：載入失敗";
                retryLibBtn.classList.remove('hidden');
            }
            initIcons(); // 狀態改變時重繪圖標
        }

        function checkLib() {
            if (typeof Archive !== 'undefined') {
                updateStatus('ready');
                return true;
            }
            return false;
        }

        // 腳本重新載入邏輯
        function loadArchiveScript() {
            updateStatus('loading');
            const oldScript = document.getElementById('archiveScript');
            if (oldScript) oldScript.remove();
            
            const script = document.createElement('script');
            script.id = 'archiveScript';
            script.src = `https://cdn.jsdelivr.net/npm/libarchive.js@1.3.0/dist/libarchive.js?t=${Date.now()}`;
            script.onload = checkLib;
            script.onerror = () => updateStatus('error');
            document.head.appendChild(script);
        }

        window.onload = () => {
            initIcons();
            if (!checkLib()) {
                setTimeout(() => {
                    if (!checkLib()) updateStatus('error');
                }, 2000);
            }
        };

        retryLibBtn.onclick = (e) => {
            e.preventDefault();
            loadArchiveScript();
        };

        async function createWorkerBlobUrl(url) {
            const response = await fetch(url);
            const script = await response.text();
            const blob = new Blob([script], { type: 'application/javascript' });
            return URL.createObjectURL(blob);
        }

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('active'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('active'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        resetBtn.addEventListener('click', () => location.reload());

        async function handleFile(file) {
            if (!checkLib()) {
                showMessage('解壓引擎尚未就緒。請確認網路連接並點擊上方的「重試載入」。', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.7z')) {
                showMessage('錯誤：請上傳 .7z 格式的檔案。', 'error');
                return;
            }

            uploadContent.classList.add('hidden');
            loadingStatus.classList.remove('hidden');
            messageBox.classList.add('hidden');

            try {
                if (!isInitialized) {
                    const workerUrl = 'https://cdn.jsdelivr.net/npm/libarchive.js@1.3.0/dist/worker-bundle.js';
                    const blobUrl = await createWorkerBlobUrl(workerUrl);
                    await Archive.init({ workerPath: blobUrl });
                    isInitialized = true;
                }

                const archive = await Archive.open(file);
                const filesObj = await archive.getFilesObject();
                displayFiles(filesObj);
                loadingStatus.classList.add('hidden');
                resultSection.classList.remove('hidden');
            } catch (err) {
                console.error(err);
                showMessage(`處理失敗：${err.message}`, 'error');
                uploadContent.classList.remove('hidden');
                loadingStatus.classList.add('hidden');
            }
        }

        function displayFiles(filesObj) {
            fileList.innerHTML = '';
            let count = 0;
            function traverse(obj, path = '') {
                for (const name in obj) {
                    const entry = obj[name];
                    const fullPath = path + name;
                    if (entry instanceof File) {
                        count++;
                        renderFileItem(entry, fullPath);
                    } else {
                        traverse(entry, fullPath + '/');
                    }
                }
            }
            traverse(filesObj);
            fileCount.textContent = count;
            initIcons();
        }

        function renderFileItem(file, fullPath) {
            const item = document.createElement('div');
            item.className = 'file-card bg-slate-50 border border-slate-200 rounded-lg p-4 flex items-center justify-between hover:bg-white transition-all';
            item.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden text-left">
                    <i data-lucide="file" class="w-6 h-6 text-blue-500 shrink-0"></i>
                    <div class="overflow-hidden">
                        <div class="text-sm font-medium text-slate-800 truncate" title="${fullPath}">${fullPath}</div>
                        <div class="text-xs text-slate-500">${(file.size / 1024).toFixed(1)} KB</div>
                    </div>
                </div>
                <button class="download-btn ml-4 shrink-0 bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white px-3 py-1.5 rounded-md text-xs font-semibold flex items-center gap-1 transition-all">
                    <i data-lucide="download" class="w-3.5 h-3.5"></i> 下載
                </button>
            `;

            const btn = item.querySelector('.download-btn');
            btn.onclick = async () => {
                btn.disabled = true;
                const originalContent = btn.innerHTML;
                btn.textContent = '解壓中...';
                try {
                    const blob = await file.extract();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fullPath.split('/').pop();
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (err) {
                    showMessage('下載失敗：' + err.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                    initIcons();
                }
            };
            fileList.appendChild(item);
        }

        function showMessage(text, type) {
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'bg-blue-50', 'text-blue-700');
            messageBox.classList.add(type === 'error' ? 'bg-red-50' : 'bg-blue-50');
            messageBox.classList.add(type === 'error' ? 'text-red-700' : 'text-blue-700');
            messageBox.classList.add('border', type === 'error' ? 'border-red-100' : 'border-blue-100');
        }
    </script>
</body>
</html>
